<div class="min-h-screen bg-gray-900 flex items-center justify-center p-4">

  <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden">

    <!-- ===================================================================
         HEADER
         =================================================================== -->
    <div class="bg-red-600 p-6 text-white flex justify-between items-center">
      <div>
        <h1 class="text-xl font-bold flex items-center gap-2">
          <app-icon name="log-out" [size]="24"></app-icon>
          Registro de Salida del Mortuorio
        </h1>
        <p class="text-red-100 text-sm">Control de Puerta - Retiro de Cad谩ver</p>
      </div>
      <div class="text-right text-sm opacity-90" *ngIf="expediente">
        <div class="font-mono font-bold text-lg">{{ expediente.codigoExpediente }}</div>
        <div class="text-xs">{{ expediente.estadoActual }}</div>
      </div>
    </div>

    <!-- ===================================================================
         PASO 1: ESCANEAR QR
         =================================================================== -->
    <div *ngIf="paso === 'escanear'" class="p-8 text-center">
      <div class="mb-6">
        <div class="inline-block p-4 bg-red-50 rounded-full text-red-500 mb-4">
          <app-icon name="qr-code" [size]="56"></app-icon>
        </div>
        <h2 class="text-2xl font-bold text-gray-800 mb-2">Escanear C贸digo QR</h2>
        <p class="text-gray-600 text-sm">
          Escanea el c贸digo QR del brazalete o ingresa manualmente el c贸digo del expediente
        </p>
      </div>

      <div class="max-w-md mx-auto space-y-4">
        <div class="relative">
          <input type="text"
                 [(ngModel)]="codigoQRInput"
                 (keyup.enter)="buscarQR()"
                 id="qr-input"
                 placeholder="SGM-2025-00001"
                 class="w-full pl-12 pr-4 py-4 border-2 border-gray-300 rounded-xl text-lg
                        focus:border-red-500 focus:ring-0 transition-colors outline-none
                        font-mono text-center"
                 autofocus>
          <div class="absolute left-4 top-5 text-gray-400">
            <app-icon name="search" [size]="24"></app-icon>
          </div>
        </div>

        <button (click)="buscarQR()"
                [disabled]="isLoading || !codigoQRInput.trim()"
                class="w-full bg-red-600 text-white font-bold py-4 rounded-xl
                       hover:bg-red-700 transition-colors shadow-lg
                       disabled:opacity-50 disabled:cursor-not-allowed
                       flex items-center justify-center gap-2">
          <app-icon *ngIf="isLoading" name="refresh-cw" [size]="20" class="animate-spin"></app-icon>
          <span>{{ isLoading ? 'BUSCANDO...' : 'BUSCAR EXPEDIENTE' }}</span>
        </button>

        <button (click)="cancelar()"
                class="w-full text-gray-600 hover:text-gray-800 py-3 rounded-xl
                       hover:bg-gray-100 transition-colors font-medium">
          Volver al Dashboard
        </button>
      </div>
    </div>

    <!-- ===================================================================
         PASO 2: FORMULARIO DE SALIDA
         =================================================================== -->
    <div *ngIf="paso === 'formulario'" class="p-6 max-h-[80vh] overflow-y-auto">

      <!-- Informaci贸n del Expediente -->
      <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg mb-6">
        <div class="flex items-start gap-3">
          <div class="text-blue-500 mt-1">
            <app-icon name="user" [size]="24"></app-icon>
          </div>
          <div class="flex-1">
            <h3 class="font-bold text-gray-800 text-lg">{{ expediente.nombreCompleto }}</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-2 text-sm text-gray-600">
              <div>
                <span class="text-gray-500">HC:</span>
                <strong class="ml-1">{{ expediente.hc }}</strong>
              </div>
              <div>
                <span class="text-gray-500">Servicio:</span>
                <strong class="ml-1">{{ expediente.servicioFallecimiento }}</strong>
              </div>
              <div>
                <span class="text-gray-500">Bandeja:</span>
                <strong class="ml-1 text-red-600">{{ expediente.codigoBandeja || 'N/A' }}</strong>
              </div>
              <div>
                <span class="text-gray-500">Estado:</span>
                <strong class="ml-1 text-blue-600">{{ expediente.estadoActual }}</strong>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Formulario -->
      <form class="space-y-6">

        <!-- Secci贸n 1: Tipo de Salida -->
        <div class="bg-white border border-gray-200 rounded-lg p-4">
          <h4 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
            <app-icon name="file-check" [size]="18"></app-icon>
            <span>Tipo de Salida</span>
          </h4>
          <select [(ngModel)]="form.tipoSalida"
                  name="tipoSalida"
                  class="w-full px-4 py-2.5 border border-gray-300 rounded-lg
                         focus:ring-2 focus:ring-red-500 focus:border-transparent
                         outline-none transition-all">
            <option value="Familiar"> Entrega a Familiar</option>
            <option value="AutoridadLegal">锔 Autoridad Legal (Fiscal铆a/PNP)</option>
            <option value="TrasladoHospital"> Traslado a otro Hospital</option>
            <option value="Otro"> Otro</option>
          </select>
        </div>

        <!-- Secci贸n 2: Datos del Responsable -->
        <div class="bg-white border border-gray-200 rounded-lg p-4">
          <h4 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
            <app-icon name="user-check" [size]="18"></app-icon>
            <span>Datos del Responsable</span>
          </h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

            <div class="md:col-span-2">
              <label class="block text-xs font-semibold text-gray-600 uppercase mb-1">
                Nombre Completo *
              </label>
              <input type="text"
                     [(ngModel)]="form.responsableNombre"
                     name="responsableNombre"
                     class="w-full px-4 py-2.5 border border-gray-300 rounded-lg
                            focus:ring-2 focus:ring-red-500 focus:border-transparent
                            outline-none transition-all"
                     placeholder="Nombre de quien retira el cuerpo"
                     required>
            </div>

            <div>
              <label class="block text-xs font-semibold text-gray-600 uppercase mb-1">
                Tipo Documento *
              </label>
              <select [(ngModel)]="form.responsableTipoDocumento"
                      name="responsableTipoDocumento"
                      class="w-full px-4 py-2.5 border border-gray-300 rounded-lg
                             focus:ring-2 focus:ring-red-500 outline-none">
                <option value="DNI">DNI</option>
                <option value="CE">Carnet de Extranjer铆a</option>
                <option value="Pasaporte">Pasaporte</option>
                <option value="CIP">CIP (Polic铆a)</option>
                <option value="RUC">RUC (Instituci贸n)</option>
              </select>
            </div>

            <div>
              <label class="block text-xs font-semibold text-gray-600 uppercase mb-1">
                N掳 Documento *
              </label>
              <input type="text"
                     [(ngModel)]="form.responsableNumeroDocumento"
                     name="responsableNumeroDocumento"
                     class="w-full px-4 py-2.5 border border-gray-300 rounded-lg
                            focus:ring-2 focus:ring-red-500 outline-none"
                     placeholder="00000000"
                     required>
            </div>

            <div>
              <label class="block text-xs font-semibold text-gray-600 uppercase mb-1">
                Parentesco
              </label>
              <input type="text"
                     [(ngModel)]="form.responsableParentesco"
                     name="responsableParentesco"
                     class="w-full px-4 py-2.5 border border-gray-300 rounded-lg
                            focus:ring-2 focus:ring-red-500 outline-none"
                     placeholder="Hijo/a, C贸nyuge, etc.">
            </div>

            <div>
              <label class="block text-xs font-semibold text-gray-600 uppercase mb-1">
                Tel茅fono
              </label>
              <input type="tel"
                     [(ngModel)]="form.responsableTelefono"
                     name="responsableTelefono"
                     class="w-full px-4 py-2.5 border border-gray-300 rounded-lg
                            focus:ring-2 focus:ring-red-500 outline-none"
                     placeholder="999 999 999">
            </div>

          </div>
        </div>

        <!-- Secci贸n 3: Autoridad Legal (condicional) -->
        <div *ngIf="form.tipoSalida === 'AutoridadLegal'"
             class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <h4 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
            <app-icon name="shield" [size]="18"></app-icon>
            <span>Autorizaci贸n Legal</span>
          </h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

            <div>
              <label class="block text-xs font-semibold text-gray-600 uppercase mb-1">
                Entidad Autorizante *
              </label>
              <select [(ngModel)]="form.entidadAutorizante"
                      name="entidadAutorizante"
                      class="w-full px-4 py-2.5 border border-gray-300 rounded-lg
                             focus:ring-2 focus:ring-yellow-500 outline-none">
                <option value="">Seleccionar...</option>
                <option value="Fiscal铆a">Fiscal铆a / Ministerio P煤blico</option>
                <option value="Polic铆aNacional">Polic铆a Nacional del Per煤</option>
                <option value="PoderJudicial">Poder Judicial</option>
                <option value="Otro">Otra Autoridad</option>
              </select>
            </div>

            <div>
              <label class="block text-xs font-semibold text-gray-600 uppercase mb-1">
                N掳 Oficio / Resoluci贸n *
              </label>
              <input type="text"
                     [(ngModel)]="form.numeroAutorizacion"
                     name="numeroAutorizacion"
                     class="w-full px-4 py-2.5 border border-gray-300 rounded-lg
                            focus:ring-2 focus:ring-yellow-500 outline-none"
                     placeholder="Ej: OF-2025-0001">
            </div>

            <div class="md:col-span-2">
              <label class="block text-xs font-semibold text-gray-600 uppercase mb-1">
                Destino Final
              </label>
              <input type="text"
                     [(ngModel)]="form.destino"
                     name="destino"
                     class="w-full px-4 py-2.5 border border-gray-300 rounded-lg
                            focus:ring-2 focus:ring-yellow-500 outline-none"
                     placeholder="Ej: Morgue Central de Lima">
            </div>

          </div>
        </div>

        <!-- Secci贸n 4: Funeraria (opcional) -->
        <div class="bg-white border border-gray-200 rounded-lg p-4">
          <h4 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
            <app-icon name="truck" [size]="18"></app-icon>
            <span>Datos de Funeraria (Opcional)</span>
          </h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

            <div class="md:col-span-2">
              <label class="block text-xs font-semibold text-gray-600 uppercase mb-1">
                Nombre de Funeraria
              </label>
              <input type="text"
                     [(ngModel)]="form.nombreFuneraria"
                     name="nombreFuneraria"
                     class="w-full px-4 py-2.5 border border-gray-300 rounded-lg
                            focus:ring-2 focus:ring-red-500 outline-none"
                     placeholder="Ej: Funeraria San Mart铆n">
            </div>

            <div>
              <label class="block text-xs font-semibold text-gray-600 uppercase mb-1">
                Conductor
              </label>
              <input type="text"
                     [(ngModel)]="form.conductorFuneraria"
                     name="conductorFuneraria"
                     class="w-full px-4 py-2.5 border border-gray-300 rounded-lg
                            focus:ring-2 focus:ring-red-500 outline-none"
                     placeholder="Nombre del conductor">
            </div>

            <div>
              <label class="block text-xs font-semibold text-gray-600 uppercase mb-1">
                DNI Conductor
              </label>
              <input type="text"
                     [(ngModel)]="form.dniConductor"
                     name="dniConductor"
                     class="w-full px-4 py-2.5 border border-gray-300 rounded-lg
                            focus:ring-2 focus:ring-red-500 outline-none"
                     placeholder="00000000">
            </div>

            <div class="md:col-span-2">
              <label class="block text-xs font-semibold text-gray-600 uppercase mb-1">
                Placa del Veh铆culo
              </label>
              <input type="text"
                     [(ngModel)]="form.placaVehiculo"
                     name="placaVehiculo"
                     class="w-full px-4 py-2.5 border border-gray-300 rounded-lg
                            focus:ring-2 focus:ring-red-500 outline-none uppercase"
                     placeholder="ABC-123">
            </div>

          </div>
        </div>

        <!-- Secci贸n 5: Validaciones -->
        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
          <h4 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
            <app-icon name="check-circle" [size]="18"></app-icon>
            <span>Validaciones Finales</span>
          </h4>
          <div class="space-y-3">


            <label class="flex items-start gap-3 cursor-pointer">
              <input type="checkbox"
                     [(ngModel)]="form.documentacionVerificada"
                     name="documentacionVerificada"
                     class="mt-1 w-5 h-5 text-red-600 border-gray-300 rounded focus:ring-red-500">

              <span class="flex flex-col">
                <span class="font-semibold text-gray-800 block">Documentaci贸n Verificada *</span>
                <span class="text-sm text-gray-600 block">
                  He verificado: DNI/documento del responsable, certificado de defunci贸n,
                  y autorizaci贸n correspondiente.
                </span>
              </span>
            </label>

            <label class="flex items-start gap-3 cursor-pointer">
              <input type="checkbox"
                     [(ngModel)]="form.pagoRealizado"
                     name="pagoRealizado"
                     class="mt-1 w-5 h-5 text-red-600 border-gray-300 rounded focus:ring-red-500">

              <span class="flex flex-col">
                <span class="font-semibold text-gray-800 block">Pagos Liquidados</span>
                <span class="text-sm text-gray-600 block">
                  Los pagos hospitalarios han sido liquidados o exonerados.
                </span>
              </span>
            </label>

            <div *ngIf="form.pagoRealizado">
              <label class="block text-xs font-semibold text-gray-600 uppercase mb-1">
                N掳 de Recibo (Opcional)
              </label>
              <input type="text"
                     [(ngModel)]="form.numeroRecibo"
                     name="numeroRecibo"
                     class="w-full px-4 py-2.5 border border-gray-300 rounded-lg
                            focus:ring-2 focus:ring-green-500 outline-none"
                     placeholder="0000000">
            </div>

          </div>
        </div>

        <!-- Observaciones -->
        <div class="bg-white border border-gray-200 rounded-lg p-4">
          <label class="block text-xs font-semibold text-gray-600 uppercase mb-2">
            Observaciones Adicionales
          </label>
          <textarea [(ngModel)]="form.observaciones"
                    name="observaciones"
                    rows="3"
                    class="w-full px-4 py-2.5 border border-gray-300 rounded-lg
                           focus:ring-2 focus:ring-red-500 outline-none resize-none"
                    placeholder="Cualquier informaci贸n adicional relevante..."></textarea>
        </div>

      </form>

      <!-- Botones de Acci贸n -->
      <div class="flex gap-4 mt-6 pt-6 border-t border-gray-200">
        <button (click)="volverAEscanear()"
                class="flex-1 py-3 text-gray-600 hover:bg-gray-100 rounded-xl
                       transition-colors font-semibold flex items-center justify-center gap-2">
          <app-icon name="arrow-left" [size]="18"></app-icon>
          <span>Volver a Escanear</span>
        </button>

        <button (click)="confirmarSalida()"
                [disabled]="isLoading || !form.documentacionVerificada"
                class="flex-1 py-3 bg-red-600 text-white rounded-xl
                       hover:bg-red-700 shadow-lg transition-all font-bold
                       disabled:opacity-50 disabled:cursor-not-allowed
                       flex items-center justify-center gap-2">
          <app-icon *ngIf="isLoading" name="refresh-cw" [size]="18" class="animate-spin"></app-icon>
          <span>{{ isLoading ? 'REGISTRANDO...' : 'REGISTRAR SALIDA' }}</span>
        </button>
      </div>

    </div>

  </div>
</div>
