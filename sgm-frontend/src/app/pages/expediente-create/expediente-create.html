<div class="min-h-screen bg-hospital-bg">

  <!-- ===================================================================
       HEADER (sin anidar div en h1)
       =================================================================== -->
  <div class="bg-gradient-to-r from-hospital-cyan to-cyan-600 border-b border-cyan-700 px-6 py-4 sticky top-0 z-10 shadow-lg">
    <div class="flex items-center justify-between max-w-7xl mx-auto">
      <div class="flex items-center gap-3">
        <div class="p-2.5 bg-white/20 backdrop-blur-sm rounded-xl shadow-md">
          <app-icon name="file-plus" [size]="26" className="text-white"></app-icon>
        </div>
        <div>
          <h1 class="text-xl font-bold text-white">
            {{ modoManual ? 'Registro Manual' : 'Nuevo Expediente' }}
          </h1>
          <p class="text-xs text-cyan-100">Sistema de Gestión Mortuoria</p>
        </div>
      </div>

      <!-- Botón Volver -->
      <button (click)="cancelar()"
              class="p-2.5 text-white hover:bg-white/20 rounded-lg transition-colors flex items-center gap-2">
        <app-icon name="chevron-left" [size]="20"></app-icon>
        <span class="hidden md:inline text-sm font-medium">Volver</span>
      </button>
    </div>
  </div>

  <!-- ===================================================================
       CONTENIDO PRINCIPAL
       =================================================================== -->
  <div class="p-4 md:p-8 max-w-7xl mx-auto">

    <!-- Banner Superior -->
    <div class="bg-gradient-to-br from-blue-50 to-cyan-50 border border-cyan-200 rounded-xl shadow-md p-6 mb-8">
      <div class="flex items-start gap-4">
        <div class="p-3 bg-hospital-cyan rounded-xl shadow-sm text-white">
          <app-icon name="clipboard" [size]="32"></app-icon>
        </div>
        <div>
          <h2 class="text-2xl font-bold text-gray-800 mb-2">
            {{ modoManual ? 'Registro Manual de Fallecido' : 'Nuevo Registro de Fallecido' }}
          </h2>
          <p class="text-gray-600 text-sm">
            {{
             modoManual
               ? 'Complete todos los campos del formulario manualmente.'
               : 'Complete los datos faltantes para generar el expediente y brazalete QR.'
            }}
          </p>
        </div>
      </div>
    </div>

    <!-- ===================================================================
         FORMULARIO
         =================================================================== -->
    <form [formGroup]="expedienteForm" (ngSubmit)="onSubmit()" class="space-y-8">

      <!-- ================================================================
           SECCIÓN 1: DATOS DEL PACIENTE
           ================================================================ -->
      <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
        <div class="p-6">
          <div class="flex items-center gap-3 border-b border-gray-200 pb-4 mb-6">
            <div class="p-2.5 bg-blue-50 rounded-lg text-hospital-cyan">
              <app-icon name="user" [size]="24"></app-icon>
            </div>
            <h3 class="text-xl font-bold text-gray-800">Datos del Paciente</h3>
          </div>

          <!-- Loading State -->
          <div *ngIf="isLoading && !pacienteData && !modoManual"
               class="text-center py-16">
            <div class="flex flex-col items-center gap-4">
              <div class="animate-spin text-hospital-cyan">
                <app-icon name="refresh-cw" [size]="48"></app-icon>
              </div>
              <span class="text-gray-600 font-medium">Cargando datos del paciente desde SIGEM...</span>
            </div>
          </div>

          <!-- Formulario Visible -->
          <div *ngIf="!isLoading || modoManual"
               class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-5">

            <!-- HC -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                Historia Clínica *
              </label>
              <input type="text"
                     formControlName="hc"
                     [readonly]="!modoManual"
                     [class]="getInputClasses(modoManual)"
                     placeholder="000000">
            </div>

            <!-- Tipo Documento -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                Tipo Documento *
              </label>
              <input *ngIf="!modoManual"
                     type="text"
                     [value]="getTipoDocumentoNombre(expedienteForm.get('tipoDocumento')?.value)"
                     readonly
                     [class]="getInputClasses(false)">
              <select *ngIf="modoManual"
                      formControlName="tipoDocumento"
                      class="w-full p-2.5 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-hospital-cyan focus:border-transparent outline-none">
                <option [value]="1">DNI</option>
                <option [value]="2">Pasaporte</option>
                <option [value]="3">Carnet de Extranjería</option>
                <option [value]="4">Sin Documento</option>
                <option [value]="5">NN</option>
              </select>
            </div>

            <!-- Número Documento -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                N° Documento *
              </label>
              <input type="text"
                     formControlName="numeroDocumento"
                     [readonly]="!modoManual"
                     [class]="getInputClasses(modoManual)"
                     placeholder="00000000">
            </div>

            <!-- Apellido Paterno -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                Apellido Paterno *
              </label>
              <input type="text"
                     formControlName="apellidoPaterno"
                     [readonly]="!modoManual"
                     [class]="getInputClasses(modoManual)">
            </div>

            <!-- Apellido Materno -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                Apellido Materno *
              </label>
              <input type="text"
                     formControlName="apellidoMaterno"
                     [readonly]="!modoManual"
                     [class]="getInputClasses(modoManual)">
            </div>

            <!-- Nombres -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                Nombres *
              </label>
              <input type="text"
                     formControlName="nombres"
                     [readonly]="!modoManual"
                     [class]="getInputClasses(modoManual)">
            </div>

            <!-- Fecha Nacimiento -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                Fecha Nacimiento *
              </label>
              <input type="date"
                     formControlName="fechaNacimiento"
                     [readonly]="!modoManual"
                     [class]="getInputClasses(modoManual)">
            </div>

            <!-- Sexo -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                Sexo *
              </label>
              <select *ngIf="modoManual"
                      formControlName="sexo"
                      class="w-full p-2.5 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-hospital-cyan outline-none">
                <option value="">Seleccione...</option>
                <option value="M">Masculino</option>
                <option value="F">Femenino</option>
              </select>
              <input *ngIf="!modoManual"
                     type="text"
                     formControlName="sexo"
                     readonly
                     [class]="getInputClasses(false)">
            </div>

            <!-- Tipo Seguro -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                Seguro / Fuente Financiamiento *
              </label>
              <input type="text"
                     formControlName="tipoSeguro"
                     [readonly]="!modoManual"
                     [class]="getInputClasses(modoManual)"
                     placeholder="Ej: SIS, Particular">
            </div>

          </div>
        </div>
      </div>

      <!-- ================================================================
           SECCIÓN 2: DATOS DEL FALLECIMIENTO
           ================================================================ -->
      <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
        <div class="p-6">
          <div class="flex items-center gap-3 border-b border-gray-200 pb-4 mb-6">
            <div class="p-2.5 bg-red-50 rounded-lg text-red-600">
              <app-icon name="alert-triangle" [size]="24"></app-icon>
            </div>
            <h3 class="text-xl font-bold text-gray-800">Datos del Fallecimiento</h3>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">

            <!-- Tipo de Expediente -->
            <div class="md:col-span-2">
              <label class="block text-sm font-semibold text-gray-700 mb-2">
                Tipo de Expediente *
              </label>
              <div class="flex gap-6">
                <label class="flex items-center cursor-pointer group">
                  <input type="radio"
                         formControlName="tipoExpediente"
                         value="Interno"
                         class="mr-2 w-4 h-4 text-hospital-cyan focus:ring-hospital-cyan">
                  <span class="text-gray-700 font-medium group-hover:text-hospital-cyan transition-colors">
                    Interno (Hospitalizado)
                  </span>
                </label>
                <label class="flex items-center cursor-pointer group">
                  <input type="radio"
                         formControlName="tipoExpediente"
                         value="Externo"
                         class="mr-2 w-4 h-4 text-hospital-cyan focus:ring-hospital-cyan">
                  <span class="text-gray-700 font-medium group-hover:text-hospital-cyan transition-colors">
                    Externo (Emergencia/Vía pública)
                  </span>
                </label>
              </div>
            </div>

            <!-- Servicio donde Falleció -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                Servicio donde Falleció *
              </label>
              <select formControlName="servicioFallecimiento"
                      class="w-full p-2.5 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-hospital-cyan outline-none">
                <option value="">Seleccione...</option>
                <option *ngFor="let srv of servicios" [value]="srv">{{ srv }}</option>
              </select>
            </div>

            <!-- Número de Cama -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                Número de Cama
              </label>
              <input type="text"
                     formControlName="numeroCama"
                     class="w-full p-2.5 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-hospital-cyan outline-none"
                     placeholder="Opcional">
            </div>

            <!-- Fecha y Hora de Fallecimiento -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                Fecha y Hora de Fallecimiento *
              </label>
              <input type="datetime-local"
                     formControlName="fechaHoraFallecimiento"
                     class="w-full p-2.5 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-hospital-cyan outline-none">
            </div>

            <!-- Diagnóstico Final -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                Diagnóstico Final (CIE-10) *
              </label>
              <input type="text"
                     formControlName="diagnosticoFinal"
                     class="w-full p-2.5 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-hospital-cyan outline-none"
                     placeholder="Ej: I21.9 - Infarto agudo de miocardio">
            </div>

            <!-- Médico que Certifica -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                Médico que Certifica *
              </label>
              <input type="text"
                     formControlName="medicoCertificaNombre"
                     class="w-full p-2.5 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-hospital-cyan outline-none"
                     placeholder="Nombre completo del médico">
            </div>

            <!-- CMP -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                CMP *
              </label>
              <input type="text"
                     formControlName="medicoCMP"
                     class="w-full p-2.5 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-hospital-cyan outline-none"
                     placeholder="N° de Colegiatura">
            </div>

            <!-- RNE -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                RNE
              </label>
              <input type="text"
                     formControlName="medicoRNE"
                     class="w-full p-2.5 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-hospital-cyan outline-none"
                     placeholder="Registro de Especialidad (opcional)">
            </div>

            <!-- Certificado SINADEF -->
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                Certificado SINADEF
              </label>
              <input type="text"
                     formControlName="numeroCertificadoSINADEF"
                     class="w-full p-2.5 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-hospital-cyan outline-none"
                     placeholder="Se llenará posteriormente (opcional)">
            </div>

          </div>
        </div>
      </div>

      <!-- ================================================================
           SECCIÓN 3: PERTENENCIAS
           ================================================================ -->
      <div class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
        <div class="p-6">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 border-b border-gray-200 pb-4 mb-6">
            <div class="flex items-center gap-3">
              <div class="p-2.5 bg-purple-50 rounded-lg text-purple-600">
                <app-icon name="archive" [size]="24"></app-icon>
              </div>
              <h3 class="text-xl font-bold text-gray-800">Registro de Pertenencias</h3>
            </div>
            <button type="button"
                    (click)="agregarPertenencia()"
                    class="flex items-center gap-2 bg-hospital-cyan text-white font-medium px-4 py-2 rounded-lg
                           text-sm hover:bg-cyan-700 transition-colors shadow-sm">
              <app-icon name="plus" [size]="18"></app-icon>
              <span>Agregar Pertenencia</span>
            </button>
          </div>

          <div formArrayName="pertenencias" class="space-y-4">
            <div *ngFor="let pertenencia of pertenencias.controls; let i = index"
                 [formGroupName]="i"
                 class="grid grid-cols-1 md:grid-cols-12 gap-4 items-center bg-gray-50 p-4 rounded-lg border border-gray-200">
              <div class="md:col-span-5">
                <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                  Descripción *
                </label>
                <input type="text"
                       formControlName="descripcion"
                       class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-hospital-cyan outline-none"
                       placeholder="Ej: Reloj Casio">
              </div>
              <div class="md:col-span-6">
                <label class="block text-sm font-semibold text-gray-700 mb-1.5">
                  Observaciones
                </label>
                <input type="text"
                       formControlName="observaciones"
                       class="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-hospital-cyan outline-none"
                       placeholder="Detalles adicionales (opcional)">
              </div>
              <div class="md:col-span-1 flex justify-end pt-6">
                <button type="button"
                        (click)="eliminarPertenencia(i)"
                        class="text-red-500 hover:text-red-700 p-2 rounded-lg hover:bg-red-100 transition-colors"
                        title="Eliminar">
                  <app-icon name="trash-2" [size]="20"></app-icon>
                </button>
              </div>
            </div>

            <div *ngIf="pertenencias.length === 0"
                 class="text-center text-gray-500 py-12 bg-gray-50 rounded-lg border border-dashed border-gray-300">
              <div class="flex flex-col items-center gap-3">
                <div class="text-gray-400">
                  <app-icon name="inbox" [size]="48"></app-icon>
                </div>
                <p class="font-medium">No se han agregado pertenencias</p>
                <p class="text-sm">Haga clic en "Agregar Pertenencia" para registrar</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ================================================================
           FOOTER: BOTONES DE ACCIÓN
           ================================================================ -->
      <div class="flex flex-col sm:flex-row justify-end items-center gap-4 p-6 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl shadow-inner border border-gray-200">
        <button type="button"
                (click)="cancelar()"
                class="flex items-center justify-center gap-2 bg-white text-gray-700 font-bold py-3 px-8
                       rounded-lg border-2 border-gray-300 hover:bg-gray-50 hover:border-gray-400
                       transition-all w-full sm:w-auto shadow-sm">
          <app-icon name="x" [size]="18"></app-icon>
          <span>Cancelar</span>
        </button>

        <button type="submit"
                [disabled]="isLoading"
                class="flex items-center justify-center gap-2 bg-hospital-cyan text-white font-bold py-3 px-8
                       rounded-lg shadow-lg hover:bg-cyan-700 transition-all
                       disabled:opacity-50 disabled:cursor-not-allowed w-full sm:w-auto">
          <div *ngIf="isLoading" class="animate-spin">
            <app-icon name="refresh-cw" [size]="18"></app-icon>
          </div>
          <div *ngIf="!isLoading">
            <app-icon name="check-circle" [size]="18"></app-icon>
          </div>
          <span>{{ isLoading ? 'GENERANDO...' : 'GENERAR EXPEDIENTE' }}</span>
        </button>
      </div>

    </form>

  </div>

</div>
